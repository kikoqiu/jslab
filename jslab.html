<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSLab</title>

  <script src="libbf.js/libbf.js"></script>
  <script src="libbf.js/bf.js"></script>
  <script>bfjs.gc_ele_limit = 100;</script>
  <!--script src="https://unpkg.com/mathjs@15.1.0/lib/browser/math.js"></script-->
  <script src="math.15.1.0.js"></script>
  <!--script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.16.0/dist/numjs.min.js" defer="defer"></script-->
  <!--script src="numjs.0.16.1.min.js" defer="defer"></script-->

  <script src="tex-svg.js"></script>
  <script src="plotly-3.3.0.min.js"></script>
  <script src="babel.min.js"></script>
  <script type="module">
    import { _Op, visitor } from "./bpo.js";
    window._Op = _Op;
    Babel.registerPlugin("bpo", visitor);
  </script>
  <script src="box.js"></script>
  <!--script src="https://unpkg.com/vue@3.1.1/dist/vue.global.prod.js"></script-->
  <script src="vue.global.3.1.1.prod.js"></script>
  <link rel="stylesheet" href="codemirror/lib/codemirror.css">
  <link rel="stylesheet" href="codemirror/addon/hint/show-hint.css">
  <link rel="stylesheet" href="codemirror/addon/lint/lint.css">
  <script src="codemirror/lib/codemirror.js"></script>
  <script src="codemirror/mode/javascript/javascript.js"></script>
  <script src="codemirror/addon/hint/show-hint.js"></script>
  <script src="codemirror/addon/hint/javascript-hint.js"></script>
  <script src="codemirror/addon/edit/closebrackets.js"></script>
  <script src="codemirror/addon/edit/matchbrackets.js"></script>
  <!--script src="https://unpkg.com/jshint@2.13.0/dist/jshint.js"></script-->
  <script src="jshint.2.13.0.js"></script>
  <script src="codemirror/addon/lint/lint.js"></script>
  <script src="codemirror/addon/lint/javascript-lint.js?v=20210802"></script>
  <script src="storage.js"></script>
  <script src="file-dialog.js"></script>
  <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"-->
  <link rel="stylesheet" href="bootstrap-icons.css">

  <style>
    /* General Styles from before */
    :root {
      --main-bg-color: #f7f7f7;
      --cell-bg-color: #ffffff;
      --border-color: #e7e7e7;
      --menu-bg-color: #ffffff;
      --menu-border-color: #d1d1d1;
      --accent-color: #2196F3;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--main-bg-color);
    }
    
    .header-content, .main-content-area {
        max-width: 1100px;
        margin: 0 auto;
    }

    .notebook-header {
      background-color: var(--menu-bg-color);
      border-bottom: 1px solid var(--menu-border-color);
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .menu-bar { display: flex; padding: 2px 0; }
    .menu-item { position: relative; padding: 6px 10px; cursor: pointer; font-size: 13px; }
    .menu-item:hover .dropdown-content { display: block; }
    .dropdown-content {
      display: none; position: absolute; background-color: white;
      min-width: 180px; box-shadow: 0px 5px 15px 0px rgba(0,0,0,0.15);
      z-index: 1001; border: 1px solid #ddd; border-radius: 4px; padding: 5px 0;
    }
    .dropdown-content a { color: black; padding: 7px 15px; text-decoration: none; display: block; font-size: 13px; }
    .dropdown-content a:hover { background-color: #f1f1f1; }
    .dropdown-content a.disabled { color: #aaa; cursor: not-allowed; }
    .dropdown-content a.disabled:hover { background-color: transparent; }

    .toolbar { display: flex; align-items: center; gap: 4px; padding: 4px 0; border-top: 1px solid var(--border-color); }
    .toolbar button {
      background: none; border: 1px solid transparent; border-radius: 3px;
      padding: 1px 5px; cursor: pointer; font-size: 16px; color: #333;
    }
    .toolbar button:hover { background-color: #eee; }
    .toolbar button:disabled { color: #ccc; cursor: not-allowed; background-color: transparent; }

    .main-content-area { padding: 20px; }
    .cells-container { 
      display: flex; flex-direction: column; gap: 5px; 
      box-shadow: 0 0 5px 1px rgba(0,0,0,0.3);
    }
    
    .cell {
      border: 1px solid transparent;
      position: relative;
      cursor: pointer;
      background-color: var(--cell-bg-color);
    }

    .selection-indicator {
        position: absolute; top: 0; bottom: 0; left: 0; width: 4px;
        background-color: var(--accent-color); visibility: hidden;
    }
    .cell.selected > .cell-part > .selection-indicator { visibility: visible; }
    
    .cell-part { position: relative; }
    .cell-input, .cell-output-wrapper { display: flex; }
    
    .cell-output-wrapper { margin-top: 5px; }

    .prompt {
      flex: 0 0 80px; padding: 10px 0; font-family: monospace;
      font-size: 12px; text-align: center; color: #3D85C6;
    }
    .prompt.out { color: #990000; }

    .editor-container { flex-grow: 1; }
    .CodeMirror { height: auto; border: none !important; }
    
    .output-container { flex-grow: 1; padding: 10px; overflow-x: auto; }
    .output-container pre { margin: 0; font-size: 14px; line-height: 1.4; white-space: pre-wrap; }

    /* File Dialog Styles */
    .file-dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }
    .file-dialog { background: #fff; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 700px; max-width: 90%; display: flex; flex-direction: column; height: 500px; }
    .file-dialog-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #ddd; font-weight: bold; }
    .file-dialog-header .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
    .file-dialog-nav { display: flex; align-items: center; padding: 5px 10px; border-bottom: 1px solid #ddd; background: #f7f7f7; }
    .file-dialog-nav button { margin-right: 10px; }
    .file-dialog-body { flex-grow: 1; overflow-y: auto; }
    .file-list { padding: 5px; }
    .file-list-item { display: flex; align-items: center; padding: 4px 8px; cursor: pointer; border-radius: 3px; }
    .file-list-item:hover { background: #f0f0f0; }
    .file-list-item.selected { background: #0078d7; color: white; }
    .file-list-item i { margin-right: 8px; font-size: 16px; }
    .file-dialog-footer { padding: 10px 15px; border-top: 1px solid #ddd; background: #f7f7f7; }
    .file-name-input { display: flex; align-items: center; margin-bottom: 10px; }
    .file-name-input label { margin-right: 10px; }
    .file-name-input input { flex-grow: 1; }
    .footer-buttons { display: flex; align-items: center; justify-content: flex-start; }
    .footer-buttons .spacer { flex-grow: 1; }
    .footer-buttons button { margin-left: 8px; }


    button { padding: 6px 12px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; background: #fff; }
    button.primary { background: #0078d7; color: white; border-color: #0078d7; }
    button.secondary { background: #6c757d; color: white; border-color: #6c757d; }
    button.danger { background: #d9534f; color: white; border-color: #d9534f; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>

<body>
  <div id="app">
    <header class="notebook-header">
       <div class="header-content">
         <nav class="menu-bar">
          <div class="menu-item"> File
            <div class="dropdown-content">
              <a href="#" @click.prevent="newFile()">New</a>
              <a href="#" @click.prevent="openFile()">Open</a>
              <a href="#" @click.prevent="saveBlock()">Save</a>
              <a href="#" @click.prevent="saveAsBlock()">Save As</a>
              <a href="#" @click.prevent="exportBlock()">Export to File</a>
              <a href="#" @click.prevent="importBlock()">Import from File</a>
              <a href="#" @click.prevent="shareBlock()">Share Link</a>
            </div>
          </div>
          <div class="menu-item"> Edit
            <div class="dropdown-content">
              <a href="#" @click.prevent="insertBlock()">Insert Cell Above</a>
              <a href="#" @click.prevent="addblock()">Insert Cell Below</a>
              <a href="#" @click.prevent="moveCellUp()" :class="{disabled: selectedIndex === 0}">Move Cell Up</a>
              <a href="#" @click.prevent="moveCellDown()" :class="{disabled: selectedIndex === blocks.length - 1}">Move Cell Down</a>
              <a href="#" @click.prevent="cutBlock()">Cut Cell</a>
              <a href="#" @click.prevent="copyBlock()">Copy Cell</a>
              <a href="#" @click.prevent="pasteBlock()" :class="{disabled: cellClipboard == null}">Paste Cell</a>
              <a href="#" @click.prevent="deleteBlock()">Delete Cell</a>
              <a href="#" @click.prevent="unDeleteBlock()" :class="{disabled: lastDeleted == null}">Undo Delete</a>
            </div>
          </div>
          <div class="menu-item"> Run
            <div class="dropdown-content">
              <a href="#" @click.prevent="evalCode()">Run Selected</a>
              <a href="#" @click.prevent="runAll()">Run All</a>
              <a href="#" @click.prevent="evalCode(true)">Debug Cell</a>
            </div>
          </div>
           <div class="menu-item"> Help
            <div class="dropdown-content">
              <a href="doc/help.html" target="_blank">Documentation</a>
              <a href="#" @click.prevent="loadHelp('help.json')">Load General Usage</a>
              <a href="#" @click.prevent="loadHelp('helpplot.json')">Load Plotting Usage</a>
              <a href="#" @click.prevent="toggleAboutModal()">About</a>
            </div>
          </div>
        </nav>
        <div class="toolbar">
          <button @click="saveBlock()" title="Save(Ctrl+S)"><i class="bi-save"></i></button>
          <button @click="addblock()" title="Insert Cell Below"><i class="bi-plus-lg"></i></button>
          <button @click="cutBlock()" title="Cut"><i class="bi-scissors"></i></button>
          <button @click="copyBlock()" title="Copy"><i class="bi-clipboard"></i></button>
          <button @click="pasteBlock()" title="Paste" :disabled="cellClipboard == null"><i class="bi-clipboard-plus"></i></button>
          <button @click="moveCellUp()" title="Move Cell Up" :disabled="selectedIndex === 0"><i class="bi bi-arrow-up-square"></i></button>
          <button @click="moveCellDown()" title="Move Cell Down" :disabled="selectedIndex === blocks.length - 1"><i class="bi bi-arrow-down-square"></i></button>
          <button @click="evalCode()" title="Run (Ctrl+Enter)"><i class="bi-play-fill"></i></button>
        </div>
       </div>
    </header>

    <div class="main-content-area">
      <div class="cells-container">
        <div v-for="(block,index) in blocks" :key="block.uuid" class="cell" :class="{selected: index === selectedIndex}" @click.self="selectedIndex = index">
          <div class="cell-part cell-input" @click="selectedIndex = index">
              <div class="selection-indicator"></div>
              <div class="prompt">In [{{ block.eindex === -1 ? '&nbsp;' : block.eindex }}]:</div>
              <div class="editor-container">
                  <codemirror v-model="block.code" @focus="selectedIndex = index"></codemirror>
              </div>
          </div>
          <div v-if="block.result" class="cell-part cell-output-wrapper" @click="selectedIndex = index">
              <div class="selection-indicator"></div>
              <div class="prompt out">Out[{{ block.eindex === -1 ? '&nbsp;' : block.eindex }}]:</div>
              <div class="output-container">
                  <code-result :html="block.result" :script="block.resultScript"></code-result>
              </div>
          </div>
        </div>
      </div>
    </div>
    
    <input type="file" ref="file" @change="handleFileImport" style="display: none">
    <a id="createInvote" style="display:none;"></a>

    <file-dialog 
      :visible="showFileDialog" 
      :mode="fileDialogMode"
      :default-name="filename"
      :vfs="vfs"
      @close="showFileDialog = false"
      @open="handleFileOpen"
      @save="handleFileSave">
    </file-dialog>

    <!-- About Modal -->
    <div v-if="showAboutModal" class="file-dialog-overlay" @click.self="toggleAboutModal">
      <div class="file-dialog" style="height: auto; max-height: 80%; width: 500px;">
        <div class="file-dialog-header">
          <span>About JSLab</span>
          <button class="close-btn" @click="toggleAboutModal"><i class="bi-x-lg"></i></button>
        </div>
        <div class="file-dialog-body" style="padding: 20px;">
          <p><strong>JSLab</strong> is an interactive JavaScript environment for rapid prototyping, data exploration, and scientific computing in the browser.</p>
          <p>Version: 1.0.0</p>
          <p>Built with Vue.js, CodeMirror, Math.js, Plotly.js, and other open-source libraries.</p>
          <p>License: MIT</p>
          <p>Special thanks to the open-source community!</p>
        </div>
        <div class="file-dialog-footer">
          <button @click="toggleAboutModal">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
const App = {
  data: () => ({
    blocks: [],
    lastDeleted: null,
    selectedIndex: 0,
    maxeIndex: 0,
    filename: '', // This now holds the full path
    uuid_pos: 0,
    cellClipboard: null,
    showFileDialog: false,
    fileDialogMode: 'open',
    vfs: new VFS(),
    showAboutModal: false,
    plotdiv:0,
  }),
  watch: {
    filename(newvalue) {
      const display = newvalue.split('/').pop();
      document.title = `JSLab - ${display}`;
    }
  },
  computed: {
    selected() {
      return this.blocks.length > this.selectedIndex ? this.blocks[this.selectedIndex] : null;
    }
  },
  async mounted() {
    const loaded = await this.loadBlock();
    if (!loaded) {
      this.addblock("echo('Welcome to JSLab!');");
      this.filename = '';
    }
    document.addEventListener("keydown", (event) => {
      if (event.ctrlKey && event.key === 'Enter') { event.preventDefault(); this.evalCode(); }
      if (event.ctrlKey && event.key === 's') { event.preventDefault(); this.saveBlock(); }
    });
  },
  methods: {
    toggleAboutModal() {
      this.showAboutModal = !this.showAboutModal;
    },
    serialize(cb) {
      this.$nextTick(() => { cb(JSON.stringify({ blocks: this.blocks, maxeIndex: this.maxeIndex, version: 0.8 })); });
    },
    clearAll() {
      Object.assign(this.$data, this.$options.data({vfs: this.vfs, showFileDialog: false, fileDialogMode: 'open'}));
      this.addblock();
      this.filename = '';
    },
    newFile() {
      if (confirm('Are you sure? Unsaved changes will be lost.')) {
        this.clearAll();
      }
    },
    openFile() {
      this.fileDialogMode = 'open';
      this.showFileDialog = true;
    },
    saveAsBlock() {
      this.fileDialogMode = 'save';
      this.showFileDialog = true;
    },
    dosave(){
      this.serialize(async (cnt) => {
          await this.vfs.saveFile(this.filename, cnt);
          await this.vfs.setLastFile(this.filename);
          alert(`Notebook "${this.filename}" saved.`);
      });
    },
    saveBlock() {
      if(this.filename == '') {
        this.saveAsBlock();
      }else{
        this.dosave();
      }
    },
    async handleFileOpen(path) {
        await this.loadBlock(path);
    },
    handleFileSave(path) {
      if(path.length<=0){
        return;
      }
      if(!path.endsWith(".json")){
        path+=".json";
      }
      this.filename = path;
      this.dosave();
    },
    loadData(filename, data) {
      this.clearAll();
      this.filename = filename;
      this.blocks = data.blocks.map(b => ({ ...b, uuid: `${Date.now()}-${this.uuid_pos++}` }));
      this.maxeIndex = data.maxeIndex || 0;
      if (this.blocks.length === 0) this.addblock();
    },
    async loadBlock(path) {
      const targetPath = path || await this.vfs.getLastFile();
      if (!targetPath) return false;

      const dataStr = await this.vfs.loadFile(targetPath);
      if (dataStr) {
        try {
          this.loadData(targetPath, JSON.parse(dataStr));
          return true;
        } catch (e) {
          alert(`Error loading notebook "${targetPath}". It might be corrupted.`);
        }
      }
      return false;
    },
    exportBlock() {
      this.serialize(cnt => {
        const el = document.getElementById('createInvote');
        el.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(cnt);
        const display = this.filename.split('/').pop();
        el.download = display || 'notebook.json'; el.click();
      });
    },
    importBlock() { this.$refs.file.click(); },
    handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          this.loadData('/' + file.name, JSON.parse(e.target.result));
        } catch (err) {
          alert("Failed to parse imported file.");
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    },
    shareBlock() {
      if (!this.selected || !this.selected.code) return;
      let url = window.location.origin + window.location.pathname + "?code=" + encodeURIComponent(this.selected.code);
      navigator.clipboard.writeText(url).then(() => alert('Shareable link for cell copied to clipboard!'), () => alert('Failed to copy link.'));
    },
    copyBlock() { if (this.selected) this.cellClipboard = JSON.parse(JSON.stringify(this.selected)); },
    cutBlock() { if (this.selected) { this.copyBlock(); this.deleteBlock(); } },
    pasteBlock() {
      if (!this.cellClipboard) return;
      const newBlock = { ...JSON.parse(JSON.stringify(this.cellClipboard)), uuid: `${Date.now()}-${this.uuid_pos++}` };
      this.blocks.splice(this.selectedIndex + 1, 0, newBlock);
      this.selectedIndex++;
    },
    moveCellUp() {
      if (this.selectedIndex > 0) {
        const i = this.selectedIndex;
        [this.blocks[i], this.blocks[i - 1]] = [this.blocks[i - 1], this.blocks[i]];
        this.selectedIndex--;
      }
    },
    moveCellDown() {
      if (this.selectedIndex < this.blocks.length - 1) {
        const i = this.selectedIndex;
        [this.blocks[i], this.blocks[i + 1]] = [this.blocks[i + 1], this.blocks[i]];
        this.selectedIndex++;
      }
    },
    loadHelp(url) {
      fetch(url).then(r => r.json()).then(d => this.appendBlocks(d.blocks))
        .catch(e => alert('Error loading help file: ' + e));
    },
    appendBlocks(blocks) {
      blocks.forEach(b => { this.blocks.push({ ...b, uuid: `${Date.now()}-${this.uuid_pos++}` }); });
    },
    formatError(source, e) {
      let pos = -1, match = null;
      let sk = e.stack.split('\n');
      let reg = /at eval \(eval at box.runcode [^\)]*\), <anonymous>:([0-9]+):([0-9]+)\)/;
      for (let i = sk.length - 1; i >= 0; --i) {
        if (pos === -1) { match = sk[i].match(reg); if (match) { pos = i; break; } }
      }
      if (pos === -1) pos = sk.length; else ++pos;
      let stack = sk.slice(0, pos).join('\n').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      let errorinfo = '';
      if (match && source) {
        try {
          let line = parseInt(match[1]) - 1, col = parseInt(match[2]) - 1;
          let sourceline = source.split('\n')[line];
          errorinfo = `<span style='color:red;'>Error At</span>[${line + 1},${col + 1}]: ${sourceline.substr(0, col)}<span style='color:red;font-weight:bold;'>&lt;--&gt</span>${sourceline.substr(col)}\n`;
        } catch (err) { } 
      }
      return `<pre>${errorinfo}<span style='color:red;'>Name</span>: ${e.name}\n<span style='color:red;'>Message</span>: ${e.message}\n<span style='color:red;'>Stack</span>:\n${stack}</pre>`;
    },
    async evalCode(debug = false) {
      if (!this.selected) return;
      const cur = this.selected;
      let info = { compiled_code: '' };
      cur.eindex = '*';
      await this.$nextTick();
      try {
        cur.result = ''; cur.resultScript = '';
        let codeToRun = cur.code;
        if (debug) codeToRun = "debugger;" + codeToRun;
        let evalresult = box.runcode(codeToRun, info);
        if (evalresult instanceof Promise) evalresult = await evalresult;
        if (evalresult !== undefined) cur.result += `<pre>${String(evalresult)}</pre>`;
      } catch (e) {
        cur.result = this.formatError(info.compiled_code, e);
        console.error(e);
      } finally {
        cur.eindex = this.maxeIndex++;
        if (!debug) {
            this.serialize(async (cnt) => {
                await this.vfs.saveFile(this.filename, cnt);
                await this.vfs.setLastFile(this.filename);
            });
        }
      }
    },
    async runAll() {
      this.maxeIndex = 0;
      for (let i = 0; i < this.blocks.length; i++) {
        this.selectedIndex = i; await this.evalCode();
      }
    },
    addblock(code = "") {
      const newBlock = { eindex: -1, code, result: null, resultScript: '', uuid: `${Date.now()}-${this.uuid_pos++}` };
      this.blocks.splice(this.selectedIndex + 1, 0, newBlock);
      this.selectedIndex++;
    },
    insertBlock() {
      const newBlock = { eindex: -1, code: "", result: null, resultScript: '', uuid: `${Date.now()}-${this.uuid_pos++}` };
      this.blocks.splice(this.selectedIndex, 0, newBlock);
    },
    deleteBlock() {
      if (this.blocks.length <= 1) return;
      const deleted = this.blocks.splice(this.selectedIndex, 1);
      this.lastDeleted = { val: deleted[0], pos: this.selectedIndex };
      if (this.selectedIndex >= this.blocks.length) this.selectedIndex = this.blocks.length - 1;
    },
    unDeleteBlock() {
      if (this.lastDeleted) {
        this.blocks.splice(this.lastDeleted.pos, 0, this.lastDeleted.val);
        this.selectedIndex = this.lastDeleted.pos;
        this.lastDeleted = null;
      }
    },
  }
};

const myapp = Vue.createApp(App);

myapp.component('file-dialog', FileDialogComponent);

myapp.component('codemirror', {
  props: ['modelValue'],
  emits: ['update:modelValue', 'focus'],
  template: `<textarea ref="codeinput"></textarea>`,
  mounted() {
    this.editor = CodeMirror.fromTextArea(this.$refs.codeinput, {
      lineNumbers: true, mode: {name: "javascript", globalVars: true},
      gutters: ["CodeMirror-lint-markers"], lint: { esversion: 11, asi: true },
      autoCloseBrackets: true, matchBrackets: true, viewportMargin: Infinity,
      extraKeys: {"": "autocomplete"},
      hintOptions: { additionalContext: box, closeOnUnfocus: false, },
    });
    this.editor.setValue(this.modelValue || '');
    this.editor.on('change', (cm, change) => {
      if (cm.getValue() !== this.modelValue) this.$emit('update:modelValue', cm.getValue());
      if (!cm.state.completionActive && change.origin === "+input" && change.text[0].match(/[a-z\.]/i)) {
        CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
      }
    });
    this.editor.on('focus', () => this.$emit('focus'));
  },
  watch: {
    modelValue(newVal) { if (newVal !== this.editor.getValue()) this.editor.setValue(newVal); }
  }
});

myapp.component('code-result', {
  props: ['html', 'script'],
  template: `<div ref="output"></div>`,
  watch: {
    html: { immediate: true, handler: 'updateContent' },
    script: { immediate: true, handler: 'updateContent' },
  },
  methods: {
      updateContent() {
          this.$nextTick(() => {
            const el = this.$refs.output; if(!el) return;
            el.innerHTML = this.html || '';
            if (this.script) {
              try { new Function(this.script)(); } catch (e) { console.error("Error executing result script:", e); }
            }
          });
      }
  }
});

vm = myapp.mount("#app");
</script>

</body>
</html>