<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSLab</title>

  <script src="workerhelper.js"></script>

  <!--script src="https://unpkg.com/vue@3.1.1/dist/vue.global.prod.js"></script-->
  <script src="vue.global.3.5.25.js"></script>
  <script src="axios.min.js"></script>

  <script src="tex-svg.js"></script>
  <script src="plotly-3.3.0.min.js"></script>
  <script src="libs/babel.min.js"></script>
  <script type="module">
    import { visitor } from "./bpo.js";
    Babel.registerPlugin("bpo", visitor);
  </script>

  <!--for math help-->
  <script src="math.15.1.0.js" defer></script>
  <script src="jshint.2.13.6.js"></script>
  <script src="codemirror6/editor.bundle.js"></script>
  <script src="compressor.js"></script>
  <script src="storage.js"></script>
  <script src="file-dialog.js"></script>
  <script src="setting-manager.js"></script>
  <script src="ai-dialog.js"></script>
  <script src="webdav.js"></script>
  <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"-->
  <link rel="stylesheet" href="bootstrap-icons.css">
  <link rel="stylesheet" href="main.css">

</head>

<body>
  <div id="app">
    <notification-message v-model="showNotification" :message="notificationMessage"></notification-message>
    <header class="notebook-header">
       <div class="header-content">
         <div class="header-top-row">
          <nav class="menu-bar">
           <div class="menu-item"> File
             <div class="dropdown-content">
               <a href="#" @click.prevent="openFile()">File Explorer</a>
               <a href="#" @click.prevent="newFile()">New</a>
               <a href="#" @click.prevent="openFile()">Open</a>
               <a href="#" @click.prevent="saveBlock()">Save</a>
               <a href="#" @click.prevent="saveAsBlock()">Save As...</a>
               <a href="#" @click.prevent="exportBlock()">Export to File</a>
               <a href="#" @click.prevent="importBlock()">Import from File</a>
               <a href="#" @click.prevent="shareBlock()">Share Link</a>
               <a href="#" @click.prevent="openAiDialog()">AI Copilot</a>
             </div>
           </div>
           <div class="menu-item"> Edit
             <div class="dropdown-content">
               <a href="#" @click.prevent="insertBlock()">Insert Cell Above</a>
               <a href="#" @click.prevent="addblock()">Insert Cell Below</a>
               <a href="#" @click.prevent="moveCellUp()" :class="{disabled: selectedIndex === 0}">Move Cell Up</a>
               <a href="#" @click.prevent="moveCellDown()" :class="{disabled: selectedIndex === blocks.length - 1}">Move Cell Down</a>
               <a href="#" @click.prevent="cutBlock()">Cut Cell</a>
               <a href="#" @click.prevent="copyBlock()">Copy Cell</a>
               <a href="#" @click.prevent="pasteBlock()" :class="{disabled: cellClipboard == null}">Paste Cell</a>
               <a href="#" @click.prevent="deleteBlock()">Delete Cell</a>
               <a href="#" @click.prevent="unDeleteBlock()" :class="{disabled: lastDeleted == null}">Undo Delete</a>
             </div>
           </div>
           <div class="menu-item"> Run
             <div class="dropdown-content">
               <a href="#" @click.prevent="evalCode()" :class="{disabled: isExecuting}">Run Selected</a>
               <a href="#" @click.prevent="runFrom(0)" :class="{disabled: isExecuting}">Run All</a>
               <a href="#" @click.prevent="runFrom(this.selectedIndex)" :class="{disabled: isExecuting}">Run Below</a>
               <a href="#" @click.prevent="evalCode(true)" :class="{disabled: isExecuting}">Debug Cell</a>
             </div>
           </div>
            <div class="menu-item"> Help
             <div class="dropdown-content">
               <a href="doc/help.html" target="_blank">Documentation</a>
               <a href="#" @click.prevent="loadHelp('help.json')">Load General Usage</a>
               <a href="#" @click.prevent="loadHelp('helpplot.json')">Load Plotting Usage</a>
               <a href="#" @click.prevent="toggleAboutModal()">About</a>
             </div>
           </div>
         </nav>
         <div class="filename-display">{{ displayFilename }}</div>
        </div>
         <div class="toolbar">
          <button @click="saveBlock()" title="Save(Ctrl+S)"><i class="bi-save"></i></button>          
          <button @click="cutBlock()" title="Cut"><i class="bi-scissors"></i></button>
          <button @click="copyBlock()" title="Copy"><i class="bi-clipboard"></i></button>
          <button @click="pasteBlock()" title="Paste" :disabled="cellClipboard == null"><i class="bi-clipboard-plus"></i></button>
          <button @click="moveCellUp()" title="Move Cell Up" :disabled="selectedIndex === 0"><i class="bi bi-arrow-up-square"></i></button>
          <button @click="moveCellDown()" title="Move Cell Down" :disabled="selectedIndex === blocks.length - 1"><i class="bi bi-arrow-down-square"></i></button>
          <button @click="addblock()" title="Insert Cell Below (Alt+Enter)"><i class="bi-plus-lg"></i></button>
          <button @click="evalCode()" title="Run (Ctrl+Enter)" class="run-button-icon-only" :disabled="isExecuting">
            <i class="bi bi-play-fill" key="play"></i>
          </button>
          <transition name="fade">  
            <i v-if="isExecuting" class="spinner" key="spinner"></i>
          </transition>
          <transition name="fade">              
              <span v-if="isExecuting" class="timer-text-standalone">
                  {{ executionTime.toFixed(2) }}s
              </span>
          </transition>
        </div>
      </div>
    </header>

    <div class="main-content-area">
      <div class="cells-container">
        <div v-for="(block,index) in blocks" :key="block.uuid" class="cell" :class="{selected: index === selectedIndex}" @click.self="selectedIndex = index">
          <div class="cell-part cell-input" @click="selectedIndex = index">
              <div class="selection-indicator"></div>
              <div class="prompt">In [{{ block.eindex === -1 ? '&nbsp;' : block.eindex }}]:</div>
              <div class="editor-container">
                  <codemirror v-model="block.code" @focus="selectedIndex = index" :has-focus="selectedIndex === index"></codemirror>
              </div>
          </div>
          <div v-if="block.result" class="cell-part cell-output-wrapper" @click="selectedIndex = index">
              <div class="selection-indicator"></div>
              <div class="prompt out">Out[{{ block.eindex === -1 ? '&nbsp;' : block.eindex }}]:</div>
              <div class="output-container">
                  <code-result :html="block.result" :script="block.resultScript"></code-result>
              </div>
          </div>
        </div>
      </div>
    </div>
    
    <input type="file" ref="file" id="file" @change="handleFileImport" style="display: none">
    <a id="createInvote" style="display:none;"></a>

    <file-dialog ref="fileDialog"
      :visible="showFileDialog"
      :mode="fileDialogMode"
      :default-name="filename"
      :vfs="vfs"
      @close="showFileDialog = false"
      @open="handleFileOpen"
      @save="handleFileSave"
      @rename="handleFileRename"
      @move="handleFileMove"
      @show-toast="showToast"
      @reload-file="handleFileReload"
    >
    </file-dialog>

    <ai-dialog
      :visible="showAiDialog"
      @close="showAiDialog = false"
    ></ai-dialog>

    <!-- About Modal -->
    <div v-if="showAboutModal" class="file-dialog-overlay" @click.self="toggleAboutModal">
      <div class="file-dialog" style="height: auto; max-height: 80%; width: 500px;">
        <div class="file-dialog-header">
          <span>About JSLab</span>
          <button class="close-btn" @click="toggleAboutModal"><i class="bi-x-lg"></i></button>
        </div>
        <div class="file-dialog-body" style="padding: 20px;">
          <p><strong>JSLab</strong> is an interactive JavaScript environment for rapid prototyping, data exploration, and scientific computing in the browser.</p>
          <p>Version: 1.0.0</p>
          <p>Built with Vue.js, CodeMirror, Math.js, Plotly.js, and other open-source libraries.</p>
          <p>License: MIT</p>
          <p>Special thanks to the open-source community!</p>
        </div>
        <div class="file-dialog-footer">
          <button @click="toggleAboutModal">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
const App = {
  data: () => ({
    blocks: [],
    lastDeleted: null,
    selectedIndex: 0,
    maxeIndex: 0,
    filename: '', // This now holds the full path
    uuid_pos: 0,
    cellClipboard: null,
    showFileDialog: false,
    fileDialogMode: 'open', // 'open' or 'save'
    vfs: new VFS(),
    showAboutModal: false,
    showAiDialog: false,
    showNotification: false,
    notificationMessage: '',
    isExecuting: false,
    executionTime: 0,
    timerInterval: null,
    isDirty: false,
    autoSaveInterval: null
  }),
  watch: {
    filename() {
      document.title = `JSLab - ${this.displayFilename}`;
    },
    blocks: {
      handler() {
        this.isDirty = true;
      },
      deep: true
    },
    isDirty() {
        document.title = `JSLab - ${this.displayFilename}`;
    }
  },
  computed: {
    displayFilename() {
      const name = this.filename ? this.filename.split('/').pop() : 'Untitled';
      return this.isDirty ? `${name}*` : name;
    },
    selected() {
      return this.blocks.length > this.selectedIndex ? this.blocks[this.selectedIndex] : null;
    }
  },
  async mounted() {
    let loaded = await this.loadBlock();
    let qcode = this.getQueryString('code');
    if(qcode != null){
      this.addblock(qcode);
      loaded = true;
    }
    if (!loaded) {
      this.addblock("echo('Welcome to JSLab!');");
      this.filename = '';
    }
    // Initial sync on load
    this.triggerSync();

    document.addEventListener("keydown", (event) => {
      if (event.ctrlKey && event.key === 'Enter') { event.preventDefault(); this.evalCode(); }
      if (event.altKey && event.key === 'Enter') { event.preventDefault(); this.addblock(); }
      if (event.ctrlKey && event.key === 's') { event.preventDefault(); this.saveBlock(); }
    });

    this.autoSaveInterval = setInterval(() => {
      if (this.filename && this.isDirty) {
        this.dosave();
      }
    }, 600000);
  },
  beforeUnmount() {
    clearInterval(this.autoSaveInterval);
  },
  methods: {
    openAiDialog() { this.showAiDialog = true; },
    toggleAboutModal() { this.showAboutModal = !this.showAboutModal; },
    triggerSync() {
        if (this.$refs.fileDialog) {
            this.$refs.fileDialog.runSync();
        }
    },
    handleFileRename({ oldPath, newPath }) {
        if (this.filename === oldPath) { this.filename = newPath; }
    },
    handleFileMove({ oldPath, newPath }) {
        if (this.filename === oldPath) { this.filename = newPath; }
    },
    handleFileReload(path) {
        if (path === this.filename) {
            this.showToast(`File reloaded due to remote changes.`);
            this.loadBlock(path);
        }
    },
    serialize(cb) {
      this.$nextTick(() => { cb(JSON.stringify({ blocks: this.blocks, maxeIndex: this.maxeIndex, version: 0.8 })); });
    },
    clearAll() {
      const vfs = this.vfs;
      Object.assign(this.$data, this.$options.data());
      this.vfs = vfs;
      this.addblock();
      this.filename = '';
    },
    newFile() {
      if (confirm('Are you sure? Unsaved changes will be lost.')) { this.clearAll(); }
    },
    openFile() {
      this.fileDialogMode = 'open';
      this.showFileDialog = true;
    },
    saveAsBlock() {
      this.fileDialogMode = 'save';
      this.showFileDialog = true;
    },
    async dosave(){
      this.serialize(async (cnt) => {
          await this.vfs.saveFile(this.filename, cnt);
          await this.vfs.setLastFile(this.filename);
          this.showToast(`Notebook "${this.filename.split('/').pop()}" saved locally.`);
          this.isDirty = false;
          
          // Trigger background WebDAV upload
          if (this.$refs.fileDialog) {
              this.$refs.fileDialog.uploadSingleFile(this.filename);
          }
      });
    },
    saveBlock() {
      if(this.filename == '') { this.saveAsBlock(); }
      else{ this.dosave(); }
    },
    async handleFileOpen(path) { await this.loadBlock(path); },
    handleFileSave(path) {
      if(path.length<=0) return;
      if(!path.endsWith(".json")) path+=".json";
      this.filename = path;
      this.dosave();
    },
    loadData(filename, data) {
      this.clearAll();
      this.filename = filename;
      this.blocks = data.blocks.map(b => ({ ...b, uuid: `${Date.now()}-${this.uuid_pos++}` }));
      this.maxeIndex = data.maxeIndex || 0;
      if (this.blocks.length === 0) this.addblock();
      this.$nextTick(() => { this.isDirty = false; });
    },
    async loadBlock(path) {
      const targetPath = path || await this.vfs.getLastFile();
      if (!targetPath) return false;
      const dataStr = await this.vfs.loadFile(targetPath);
      if (dataStr) {
        try {
          this.loadData(targetPath, JSON.parse(dataStr));
          return true;
        } catch (e) { alert(`Error loading notebook "${targetPath}". It might be corrupted.`); }
      }
      return false;
    },
    exportBlock() {
      this.serialize(cnt => {
        const el = document.getElementById('createInvote');
        el.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(cnt);
        const display = this.filename.split('/').pop();
        el.download = display || 'notebook.json'; el.click();
      });
    },
    importBlock() { this.$refs.file.click(); },
    handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          this.loadData('/' + file.name, JSON.parse(e.target.result));
        } catch (err) { alert("Failed to parse imported file."); }
      };
      reader.readAsText(file);
      event.target.value = '';
    },
    shareBlock() {
      if (!this.selected || !this.selected.code) return;
      let url = window.location.origin + window.location.pathname + "?code=" + encodeURIComponent(this.selected.code);
      navigator.clipboard.writeText(url).then(() => alert('Shareable link for cell copied to clipboard!'), () => alert('Failed to copy link.'));
    },
    copyBlock() { if (this.selected) this.cellClipboard = JSON.parse(JSON.stringify(this.selected)); },
    cutBlock() { if (this.selected) { this.copyBlock(); this.deleteBlock(); } },
    pasteBlock() {
      if (!this.cellClipboard) return;
      const newBlock = { ...JSON.parse(JSON.stringify(this.cellClipboard)), uuid: `${Date.now()}-${this.uuid_pos++}` };
      this.blocks.splice(this.selectedIndex + 1, 0, newBlock);
      this.selectedIndex++;
    },
    moveCellUp() {
      if (this.selectedIndex > 0) {
        const i = this.selectedIndex;
        [this.blocks[i], this.blocks[i - 1]] = [this.blocks[i - 1], this.blocks[i]];
        this.selectedIndex--;
      }
    },
    moveCellDown() {
      if (this.selectedIndex < this.blocks.length - 1) {
        const i = this.selectedIndex;
        [this.blocks[i], this.blocks[i + 1]] = [this.blocks[i + 1], this.blocks[i]];
        this.selectedIndex++;
      }
    },
    loadHelp(url) {
      fetch(url).then(r => r.json()).then(d => this.appendBlocks(d.blocks))
        .catch(e => alert('Error loading help file: ' + e));
    },
    appendBlocks(blocks) {
      blocks.forEach(b => { this.blocks.push({ ...b, uuid: `${Date.now()}-${this.uuid_pos++}` }); });
    },
    formatError(source, e) {
      let pos = -1, match = null;
      let sk = e.stack.split('\n');
      let reg = /at eval \(eval at self.onmessage [^\)]*\), <anonymous>:([0-9]+):([0-9]+)\)/;
      for (let i = 0; i <= sk.length - 1; ++i) {
        if (pos === -1) { match = sk[i].match(reg); if (match) { pos = i; break; } }
      }
      if (pos === -1) pos = sk.length; else ++pos;
      let stack = sk.slice(0, pos).join('\n').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      let errorinfo = '';
      if (match && source) {
        try {
          let line = parseInt(match[1]) - 1, col = parseInt(match[2]) - 1;
          let sourceline = source.split('\n')[line];
          errorinfo = `<span style='color:red;'>Error At </span> [${line - 2}, ${col + 1}]: ${sourceline.substr(0, col)}<span style='color:red;font-weight:bold;'>--&gt</span>${sourceline.substr(col)}\n`;
        } catch (err) { } 
      }
      return `<pre>${errorinfo}<span style='color:red;'>Name</span>: ${e.name}\n<span style='color:red;'>Message</span>: ${e.message}\n</pre>`;
    },
    delay(durationMs) {
      return new Promise(resolve => setTimeout(resolve, durationMs));
    },
    async _evalCell(cur, debug = false) {
      let info = { compiled_code: '' };
      cur.eindex = '*';
      await this.$nextTick();
      await this.delay(20); // Allow UI to update
      try {
        //cur.result = ''; 
        cur.resultScript = '';
        let codeToRun = cur.code;
        if (debug) codeToRun = "debugger;\n" + codeToRun;
        let evalresult = workerhelper.runcode(codeToRun, info);
        if (evalresult instanceof Promise) evalresult = await evalresult;
        if (evalresult !== undefined) cur.result += `<pre>${String(evalresult)}</pre>`;
      } catch (e) {
        cur.result = this.formatError(info.compiled_code, e);
        cur.resultScript = '';
        console.error(e);
      } finally {
        cur.eindex = this.maxeIndex++;
        /*if (!debug) {
            this.serialize(async (cnt) => {
                await this.vfs.saveFile(this.filename, cnt);
                await this.vfs.setLastFile(this.filename);
            });
        }*/
      }
    },
    async evalCode(debug = false) {
      if (this.isExecuting) return;
      if(this.filename == '') {
        this.saveAsBlock();
        return;
      }
      if (!this.selected) return;

      this.isExecuting = true;
      this.executionTime = 0;
      const startTime = performance.now();
      this.timerInterval = setInterval(() => {
        this.executionTime = (performance.now() - startTime) / 1000;
      }, 10);
      
      try {
        await this._evalCell(this.selected, debug);
      } finally {
        this.isExecuting = false;
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
    },
    async runFrom(startIndex) {
      startIndex = startIndex === undefined ? 0 : startIndex;
      if (this.isExecuting) return;
      if(this.filename == '') {
        this.saveAsBlock();
        return;
      }

      this.isExecuting = true;
      this.executionTime = 0;
      const startTime = performance.now();
      this.timerInterval = setInterval(() => {
        this.executionTime = (performance.now() - startTime) / 1000;
      }, 10);

      try {
        if(startIndex === 0){
          this.maxeIndex = 0;
        }
        for (let i = startIndex; i < this.blocks.length; i++) {
          this.selectedIndex = i;
          await this._evalCell(this.blocks[i], false); // always run in non-debug for runAll
        }
      } finally {
        this.isExecuting = false;
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
    },
    addblock(code = "") {
      const newBlock = { eindex: -1, code, result: null, resultScript: '', uuid: `${Date.now()}-${this.uuid_pos++}` };
      this.blocks.splice(this.selectedIndex + 1, 0, newBlock);
      this.selectedIndex++;
    },
    insertBlock() {
      const newBlock = { eindex: -1, code: "", result: null, resultScript: '', uuid: `${Date.now()}-${this.uuid_pos++}` };
      this.blocks.splice(this.selectedIndex, 0, newBlock);
    },
    deleteBlock() {
      if (this.blocks.length <= 1) return;
      const deleted = this.blocks.splice(this.selectedIndex, 1);
      this.lastDeleted = { val: deleted[0], pos: this.selectedIndex };
      if (this.selectedIndex >= this.blocks.length) this.selectedIndex = this.blocks.length - 1;
    },
    unDeleteBlock() {
      if (this.lastDeleted) {
        this.blocks.splice(this.lastDeleted.pos, 0, this.lastDeleted.val);
        this.selectedIndex = this.lastDeleted.pos;
        this.lastDeleted = null;
      }
    },
    showToast(message) {
      this.notificationMessage = message;
      this.showNotification = true;
    },    
    getQueryString(name) {
        let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        let r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return decodeURIComponent(r[2]);
        };
        return null;
    }
  }
};

const myapp = Vue.createApp(App);

myapp.component('file-dialog', FileDialogComponent);
myapp.component('ai-dialog', AiDialogComponent);

myapp.component('codemirror', window.CodeMirror6VueComponent);

myapp.component('code-result', {
  props: ['html', 'script'],
  template: `<div ref="output"></div>`,
  watch: {
    html: { immediate: true, handler: 'updateContent' },
    script: { immediate: true, handler: 'updateContent' },
  },
  methods: {
      updateContent() {
          this.$nextTick(() => {
            const el = this.$refs.output; 
            if(!el) return;
            el.innerHTML = this.html || '';
            if (this.script) {
              try { 
                new Function(this.script)(); 
              } catch (e) {
                console.error("Error executing result script:", e);
              }
            }
          });
      }
  }
});


myapp.component('notification-message', {
  props: {
    message: String,
    modelValue: Boolean, // Use modelValue for v-model compatibility
  },
  emits: ['update:modelValue'],
  template: `
    <transition name="slide-fade">
      <div v-if="modelValue" class="top-notification">
        {{ message }}
      </div>
    </transition>
  `,
  data() {
    return {
      timeoutId: null,
    };
  },
  watch: {
    modelValue(newVal) {
      if (newVal) {
        clearTimeout(this.timeoutId);
        this.timeoutId = setTimeout(() => {
          this.$emit('update:modelValue', false);
        }, 2000); // Auto-dismiss after 2 seconds
      }
    },
  },
  methods: {
    dismiss() {
      clearTimeout(this.timeoutId);
      this.$emit('update:modelValue', false);
    },
  },
});

vm = myapp.mount("#app");
</script>

</body>
</html>